CREATE DATABASE HOTEL_DB;

USE HOTEL_DB;

-- CREATE TABLE --
CREATE TABLE LOAIPHONG (
	MaLoaiPhong VARCHAR(20),
    TenLoaiPhong VARCHAR(20),
	DonGia INT
);

CREATE TABLE PHONG (
	MaPhong VARCHAR(20),
	TenPhong VARCHAR(20),
    MaLoaiPhong VARCHAR(20),
    GhiChu NVARCHAR(100),
    TinhTrang INT
);

CREATE TABLE LOAIKHACH (
	MaLoaiKhach VARCHAR(20),
    TenLoaiKhach NVARCHAR(20),
    HeSoPhuThu FLOAT
);


CREATE TABLE PHIEUTHUEPHONG(
	MaPhieuThue VARCHAR(20),
    MaPhong VARCHAR(20),
    NgayThue DATETIME,
    NgayTra DATETIME,
    DonGiaMotNgay FLOAT,
	TinhTrangTraTien INT
);

CREATE TABLE CHITIET_PTP(
    MaKhachHang VARCHAR(20),
    MaPhieuThue VARCHAR(20),
    TenKhachHang NVARCHAR(30),
    DiaChi NVARCHAR(50),
    CMND VARCHAR(20),
	MaLoaiKhach VARCHAR(20)
);

CREATE TABLE HOADON (
	MaHoaDon VARCHAR(20),
    TenKhachHang NVARCHAR(30),
    NgayLap DATETIME,
    NgayThanhToan DATETIME,
    TriGia FLOAT,
    TinhTrangThanhToan INT
);



CREATE TABLE CHITIETHOADON (
	MaChiTietHoaDon VARCHAR(20),
    MaHoaDon VARCHAR(20),
    MaPhieuThue VARCHAR(20),
    SoNgayThue INT,
    ThanhTien FLOAT
);

CREATE TABLE TILEPHUTHU (
	KhachThu INT,
	TiLePhuThu FLOAT
);

CREATE TABLE DOANHTHU (
	Thang INT,
    Nam INT,
	MaLoaiPhong VARCHAR(20),
    DoanhThu FLOAT,
    TiLe Float
);


CREATE TABLE THAMSO(
	TenThamSo VARCHAR(255),
	GiaTri FLOAT
);

CREATE TABLE PHANQUYEN(
	MaPhanQuyen VARCHAR(20),
	TenPhanQuyen NVARCHAR(255),
	QuyenDanhMucPhong INT,
	QuyenPhieuThuePhong INT,
	QuyenTraCuuPhong INT,
	QuyenLapHoaDonThanhToan INT,
	QuyenLapBaoCaoDoanhThu INT,
	QuyenLapPhanQuyen INT,
	QuyenLapQuyDinh INT
);

CREATE TABLE NGUOIDUNG(
	TenDangNhap VARCHAR(50),
	MatKhau VARCHAR(50),
	HoTen NVARCHAR(50),
	MaPhanQuyen VARCHAR(20)
);

-- CREATE CONSTRAINT --
-- PRIMARY KEY
ALTER TABLE PHONG ADD CONSTRAINT PK_MaPhong PRIMARY KEY (MaPhong);
ALTER TABLE LOAIPHONG ADD CONSTRAINT PK_MaLoaiPhong PRIMARY KEY (MaLoaiPhong);
ALTER TABLE LOAIKHACH ADD CONSTRAINT PK_MaLoaiKhach PRIMARY KEY (MaLoaiKhach);
ALTER TABLE PHIEUTHUEPHONG ADD CONSTRAINT PK_MaPhieuThue PRIMARY KEY (MaPhieuThue);
ALTER TABLE CHITIET_PTP ADD CONSTRAINT PK_MaKhachHang PRIMARY KEY (MaKhachHang);
ALTER TABLE HOADON ADD CONSTRAINT PK_MaHoaDon PRIMARY KEY (MaHoaDon);
ALTER TABLE CHITIETHOADON ADD CONSTRAINT PK_MaChiTietHoaDon PRIMARY KEY (MaChiTietHoaDon);
ALTER TABLE DOANHTHU ADD CONSTRAINT PK_Thang_Nam_MaLoaiPhong PRIMARY KEY (Thang, Nam, MaLoaiPhong);
ALTER TABLE THAMSO ADD CONSTRAINT PK_TenThamSo PRIMARY KEY (TenThamSo);
ALTER TABLE TILEPHUTHU ADD CONSTRAINT PK_KhachThu PRIMARY KEY (KhachThu);
ALTER TABLE PHANQUYEN ADD CONSTRAINT PK_MaPhanQuyen PRIMARY KEY (MaPhanQuyen);
ALTER TABLE NGUOIDUNG ADD CONSTRAINT PK_TenDangNhap PRIMARY KEY (TenDangNhap);

-- FOREIGN KEY

ALTER TABLE PHONG ADD CONSTRAINT FK_MaLoaiPhong_Phong FOREIGN KEY (MaLoaiPhong) REFERENCES LOAIPHONG(MaLoaiPhong);
ALTER TABLE PHIEUTHUEPHONG ADD CONSTRAINT FK_MaPhong_PTP FOREIGN KEY (MaPhong) REFERENCES PHONG (MaPhong);
ALTER TABLE CHITIET_PTP ADD CONSTRAINT FK_MaLoaiKhach_ChiTiet_PTP FOREIGN KEY (MaLoaiKhach) REFERENCES LOAIKHACH(MaLoaiKhach),
						ADD CONSTRAINT FK_MaPhieuThue_ChiTiet_PTP FOREIGN KEY (MaPhieuThue) REFERENCES PHIEUTHUEPHONG(MaPhieuThue);
ALTER TABLE CHITIETHOADON ADD CONSTRAINT FK_MaHoaDon_ChiTietHoaDon FOREIGN KEY(MaHoaDon) REFERENCES HOADON(MaHoaDon),
						ADD CONSTRAINT FK_MaPhieuThue_ChiTietHoaDon FOREIGN KEY(MaPhieuThue) REFERENCES PHIEUTHUEPHONG(MaPhieuThue);
ALTER TABLE DOANHTHU ADD CONSTRAINT FK_MaLoaiPhong_DoanhThu FOREIGN KEY(MaLoaiPhong) REFERENCES LOAIPHONG(MaLoaiPhong);
ALTER TABLE NGUOIDUNG ADD CONSTRAINT FK_MaPhanQuyen_NguoiDung FOREIGN KEY(MaPhanQuyen) REFERENCES PHANQUYEN(MaPhanQuyen);
-- UNIQUE ROOM
ALTER TABLE PHONG ADD CONSTRAINT Unique_TenPhong UNIQUE(TenPhong);


-- CONSTRAINT FOR MAXIMUM CUSTOMER PER ROOM --
INSERT INTO THAMSO VALUES("SoKhachToiDaMotPhong", 3);

INSERT INTO LOAIPHONG VALUES("LP1", "A", 150000);
INSERT INTO LOAIPHONG VALUES("LP2", "B", 170000);
INSERT INTO LOAIPHONG VALUES("LP3", "C", 200000);

INSERT INTO LOAIKHACH VALUES("LK1", "Nội địa", 1.0);
INSERT INTO LOAIKHACH VALUES("LK2", "Nước ngoài", 1.5);

INSERT INTO TILEPHUTHU VALUES(1, 1), (2, 1), (3, 1.25);

insert into phanquyen values("PHANQUYEN1","Siêu quản trị",1,1,1,1,1,1,1);
insert into phanquyen values("PHANQUYEN2","Giám đốc",0,0,0,1,1,0,1);
insert into phanquyen values("PHANQUYEN3","Quản lý",1,1,1,1,1,0,1);
insert into phanquyen values("PHANQUYEN4","Nhân viên",1,1,1,1,0,0,0);

insert into nguoidung values("superadmin@gmail.com","admin","Siêu quản trị","PHANQUYEN1");
insert into nguoidung values("tinhvila@gmail.com","admin","Đăng Tỉnh","PHANQUYEN2");
insert into nguoidung values("tinhpd@gmail.com","admin","Tinhvila","PHANQUYEN3");
insert into nguoidung values("pdtinh@gmail.com","admin","Tỉnh Phạm","PHANQUYEN4");

SELECT * FROM DOANHTHU;
UPDATE HOADON SET TinhTrangThanhToan = 0 WHERE MaHoaDon="HD2";
UPDATE DOANHTHU SET TiLe = 1 WHERE MaLoaiPhong = "LP1";
SELECT * FROM HOADON;

INSERT INTO DOANHTHU VALUES(6, 2024, "LP1", 0, 0);
INSERT INTO DOANHTHU VALUES(6, 2024, "LP2", 0, 0);
INSERT INTO DOANHTHU VALUES(6, 2024, "LP3", 0, 0);

INSERT INTO DOANHTHU VALUES(7, 2024, "LP1", 0, 0);
INSERT INTO DOANHTHU VALUES(7, 2024, "LP2", 0, 0);
INSERT INTO DOANHTHU VALUES(7, 2024, "LP3", 0, 0);

INSERT INTO DOANHTHU VALUES(8, 2024, "LP1", 0, 0);
INSERT INTO DOANHTHU VALUES(8, 2024, "LP2", 0, 0);
INSERT INTO DOANHTHU VALUES(8, 2024, "LP3", 0, 0);